{{- if not (.Get "name") -}}
<p>Error: No map name specified. Please specify a map name in the shortcode. Example: \{\{&lt; map name="mapname" &gt;\}\}</p>
{{- else -}}
  {{- $mapConfigName := .Get "name" -}}
  {{- $hugoMapsConfig := index site.Params "hugo-maps" -}}
  {{- $mapparams := index $hugoMapsConfig $mapConfigName -}}

  {{- if not $mapparams -}}
<p>Error: Map name {{- $mapConfigName -}} not found in config. Please check your config file.</p>
  {{- else -}}
    {{- $mapname := md5 now.UnixNano -}}
    {{- $baseparams := (resources.Get "default/mapparams.yaml") | unmarshal -}}
    {{- $defaultparams := index $hugoMapsConfig "default" | default dict -}}
    {{- $mapparams = merge $baseparams $defaultparams $mapparams -}}

    {{- $mapstyle := dict -}}

    {{- if eq ($mapparams.type | default "remote") "remote" -}}
      {{- $sources := dict "sources" ($mapparams.sources | default dict) -}}
      {{- $glyphs := dict "glyphs" ($mapparams.glyphs | default "https://fonts.openmaptiles.org/{fontstack}/{range}.pbf") -}}
      {{- $mapstyle = resources.Get (printf "map-styles/%s.json" ($mapparams.style | default "osm-bright")) | unmarshal -}}
      {{- $mapstyle = merge $mapstyle $sources $glyphs -}}
    {{- end -}}

    <script src='{{ (resources.Get "js/maplibre-gl.js").RelPermalink }}'></script>
    <link href='{{ (resources.Get "css/maplibre-gl.css").RelPermalink }}' rel='stylesheet' />

    <style>
      #map-{{ $mapname }} {
        width: {{ .Get "width" | default $mapparams.width }};
        height: {{ .Get "height" | default $mapparams.height }};
      }
    </style>

    <div id='map-{{ $mapname }}'></div>

    <script>
      // Suppress source map 404 errors
      if (window.addEventListener) {
        window.addEventListener('error', function(e) {
          if (e.filename && e.filename.includes('.map')) {
            e.preventDefault();
          }
        }, true);
      }

      // Helper function to validate LngLat coordinates
      function validateLngLat(coords) {
        if (!coords) return [-0.127758, 51.507351];
        if (Array.isArray(coords) && coords.length === 2) {
          const [lng, lat] = coords;
          if (typeof lng === 'number' && typeof lat === 'number' && 
              lng >= -180 && lng <= 180 && lat >= -90 && lat <= 90) {
            return coords;
          }
        }
        if (typeof coords === 'object' && coords !== null) {
          const lng = coords.lng || coords.lon;
          const lat = coords.lat;
          if (typeof lng === 'number' && typeof lat === 'number' &&
              lng >= -180 && lng <= 180 && lat >= -90 && lat <= 90) {
            return [lng, lat];
          }
        }
        console.warn('Invalid coordinates:', coords, '- using default');
        return [-0.127758, 51.507351];
      }

      window.addEventListener("load", function() {
        const map = new maplibregl.Map({
          container: 'map-{{ $mapname }}',
          center: validateLngLat({{ $mapparams.center | jsonify }}),
          minZoom: {{ $mapparams.minZoom | default 0 }},
          maxZoom: {{ $mapparams.maxZoom | default 23 }},
          zoom: {{ $mapparams.zoom | default 11 }},
          bearing: {{ $mapparams.bearing | default 0 }},
          minPitch: {{ $mapparams.minPitch | default 0 }},
          maxPitch: {{ $mapparams.maxPitch | default 60 }},
          pitch: {{ $mapparams.pitch | default 0 }},
          antialias: {{ $mapparams.antialias | default false }},
          attributionControl: {{ $mapparams.attributionControl | default true }},
          customAttribution: "{{ $mapparams.customAttribution | default "" }}",
          interactive: {{ $mapparams.interactive | default true }},
          style: {{ $mapstyle | jsonify | safeJS }}
        });

        {{- if $mapparams.navigationControl }}
        map.addControl(new maplibregl.NavigationControl());
        {{- end }}

        {{- range $mapparams.markers }}
        new maplibregl.Marker()
          .setLngLat(validateLngLat({{ .location | jsonify }}))
          .setPopup(new maplibregl.Popup().setHTML("{{ .text }}"))
          .addTo(map);
        {{- end }}

        {{- range $mapparams.setfeaturestate }}
        map.on('data', function(e) {
          map.setFeatureState({{ .feature | jsonify }}, {{ .state | jsonify }});
        });
        {{- end }}
      });
    </script>
  {{- end -}}
{{- end -}}