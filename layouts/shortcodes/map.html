{{- if not (.Get "name") -}}
<p>Error: No map name specified. Please specify a map name in the shortcode. Example: \{\{&lt; map name="mapname" &gt;\}\}</p>
{{- else -}}
  {{- $mapConfigName := .Get "name" -}}
  {{- $mapAddress := .Get "address" | default .Page.Params.address -}}
  {{- $hugoMapsConfig := index site.Params "hugo-maps" -}}
  {{- $mapparams := index $hugoMapsConfig $mapConfigName -}}

  {{- if not $mapparams -}}
<p>Error: Map name {{- $mapConfigName -}} not found in config. Please check your config file.</p>
  {{- else -}}
    {{- $mapname := md5 now.UnixNano -}}
    {{- $baseparams := (resources.Get "default/mapparams.yaml") | unmarshal -}}
    {{- $defaultparams := index $hugoMapsConfig "default" | default dict -}}
    {{- $mapparams = merge $baseparams $defaultparams $mapparams -}}
    {{- $addressZoom := .Get "address-zoom" | default .Page.Params.addressZoom | default ($mapparams.addressZoom | default "") -}}

    {{- $mapstyle := dict -}}

    {{- if eq ($mapparams.type | default "remote") "remote" -}}
      {{- $sources := dict "sources" ($mapparams.sources | default dict) -}}
      {{- $mapstyle = resources.Get (printf "map-styles/%s.json" ($mapparams.style | default "osm-bright")) | unmarshal -}}
      {{- $mapstyle = merge $mapstyle $sources -}}
    {{- end -}}

    <script src='https://cdn.jsdelivr.net/npm/maplibre-gl@5.17.0/dist/maplibre-gl.js'></script>
    <link href='https://cdn.jsdelivr.net/npm/maplibre-gl@5.17.0/dist/maplibre-gl.css' rel='stylesheet' />

    <style>
      #map-{{ $mapname }} {
        width: {{ .Get "width" | default $mapparams.width }};
        height: {{ .Get "height" | default $mapparams.height }};
      }
    </style>

    <div id='map-{{ $mapname }}'></div>

    <script>
      // Setup global helpers if needed
      if (!window.hugoMapsHelpers) {
        window.hugoMapsHelpers = {
          validateLngLat: function(coords) {
            if (!coords) return null;
            if (typeof coords === 'string') {
              try {
                coords = JSON.parse(coords);
              } catch (e) {
                return null;
              }
            }
            if (Array.isArray(coords) && coords.length === 2) {
              const [first, second] = coords;
              if (typeof first === 'number' && typeof second === 'number' && 
                  first >= -180 && first <= 180 && second >= -90 && second <= 90) {
                return coords;
              }
            }
            if (typeof coords === 'object' && coords !== null) {
              let lng = coords.lng || coords.lon;
              let lat = coords.lat;
              if (typeof lng === 'number' && typeof lat === 'number' &&
                  lng >= -180 && lng <= 180 && lat >= -90 && lat <= 90) {
                return [lng, lat];
              }
            }
            return null;
          },

          geocoderApi: {
            forwardGeocode: async function(config) {
              const features = [];
              try {
                const searchQuery = encodeURIComponent(config.query);
                const request = `https://nominatim.openstreetmap.org/search?q=${searchQuery}&format=geojson&polygon_geojson=1&addressdetails=1`;
                const response = await fetch(request);
                const geojson = await response.json();
                
                for (const feature of geojson.features) {
                  const center = [
                    feature.bbox[0] + (feature.bbox[2] - feature.bbox[0]) / 2,
                    feature.bbox[1] + (feature.bbox[3] - feature.bbox[1]) / 2
                  ];
                  features.push({
                    type: 'Feature',
                    geometry: { type: 'Point', coordinates: center },
                    place_name: feature.properties.display_name,
                    properties: feature.properties,
                    text: feature.properties.display_name,
                    place_type: ['place'],
                    center
                  });
                }
              } catch (e) {
                console.error('Geocoder error:', e);
              }
              return { features };
            }
          }
        };
      }

      // Immediately initialize this map (IIFE)
      (function() {
        function tryInit() {
          if (typeof maplibregl === 'undefined') {
            setTimeout(tryInit, 50);
            return;
          }

          const mapId = 'map-{{ $mapname }}';
          const container = document.getElementById(mapId);
          if (!container) {
            console.error('Map container not found:', mapId);
            return;
          }

          const center = window.hugoMapsHelpers.validateLngLat({{ $mapparams.center | jsonify }}) || [-0.127758, 51.507351];
          
          const map = new maplibregl.Map({
            container: mapId,
            center: center,
            minZoom: {{ $mapparams.minZoom | default 0 }},
            maxZoom: {{ $mapparams.maxZoom | default 23 }},
            zoom: {{ $mapparams.zoom | default 11 }},
            bearing: {{ $mapparams.bearing | default 0 }},
            minPitch: {{ $mapparams.minPitch | default 0 }},
            maxPitch: {{ $mapparams.maxPitch | default 60 }},
            pitch: {{ $mapparams.pitch | default 0 }},
            antialias: {{ $mapparams.antialias | default false }},
            attributionControl: {{ $mapparams.attributionControl | default true }},
            customAttribution: "{{ $mapparams.customAttribution | default "" }}",
            interactive: {{ $mapparams.interactive | default true }},
            style: {{ $mapstyle | jsonify | safeJS }}
          });

          {{- if $mapparams.navigationControl }}
          map.addControl(new maplibregl.NavigationControl());
          {{- end }}

          {{- if $mapAddress }}
          const handleGeocode = function() {
            window.hugoMapsHelpers.geocoderApi.forwardGeocode({query: '{{ $mapAddress }}'})
              .then((result) => {
                if (result.features && result.features.length > 0) {
                  const feature = result.features[0];
                  {{- if $addressZoom }}
                  const addressZoom = {{ $addressZoom }};
                  {{- else }}
                  const addressZoom = {{ $mapparams.zoom | default 11 }};
                  {{- end }}
                  map.flyTo({
                    center: feature.center,
                    zoom: addressZoom,
                    duration: 2500,
                    bearing: {{ $mapparams.bearing | default 0 }},
                    pitch: {{ $mapparams.pitch | default 0 }}
                  });
                  // Create a marker at the geocoded location with a popup
                  new maplibregl.Marker()
                    .setLngLat(feature.center)
                    .setPopup(
                      new maplibregl.Popup()
                        .setHTML("<strong>{{ .Page.Title }}</strong>")
                    )
                    .addTo(map)
                    .togglePopup();
                }
              })
              .catch((err) => {
                console.error('Geocode error:', err);
              });
          };
          
          if (map.isStyleLoaded()) {
            handleGeocode();
          } else {
            map.on('load', handleGeocode);
          }
          {{- end }}

          {{- range $mapparams.markers }}
          new maplibregl.Marker()
            .setLngLat(window.hugoMapsHelpers.validateLngLat({{ .location | jsonify }}))
            .setPopup(new maplibregl.Popup().setHTML("{{ .text }}"))
            .addTo(map);
          {{- end }}

          {{- range $mapparams.setfeaturestate }}
          map.on('data', function(e) {
            map.setFeatureState({{ .feature | jsonify }}, {{ .state | jsonify }});
          });
          {{- end }}
        }

        // Trigger on DOM ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', tryInit);
        } else {
          tryInit();
        }
      })();
    </script>
  {{- end -}}
{{- end -}}